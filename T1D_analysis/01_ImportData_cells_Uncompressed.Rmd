---
title: "01_ImportData"
author: "Nathan Steenbuck"
date: "Created: 23 Oct, 2024; Compiled: `r format(Sys.time(), '%d %b, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: inline
---


```{r setup, include=FALSE}
script_name <- "01_ImportData_cells_Uncompressed.Rmd"

source(file.path("/", "mnt", "central_nas", "projects", 
                 "type1_diabetes", "nathan", "BlockCourse", "2024_BlockCourse", "T1D_analysis", 
                "helpers.R"))
n_cores <- 2
future::plan(future::multicore(workers = n_cores))
paths <- getPaths(script_name)
knitr::opts_knit$set(root_dir = paths$cluster_home)
do_print <- TRUE

# Misc. Settings.
seed <- 123456
set.seed(seed)
options <- furrr::furrr_options(seed = seed)
options(future.globals.maxSize = 30 * 1024 * 1024 * 1024)
knitr::opts_chunk$set(echo = TRUE)
```


# **Goal**

This script loads cell-level data obtained after running the Pre-processing pipeline.

All cell-level data are stored in a [SpatialExperiment (SPE)](https://bioconductor.org/packages/release/bioc/html/SpatialExperiment.html)
object that will be used by downstream analysis scripts.  

This script can be from the 
Rscript -e "rmarkdown::render('2024_BlockCourse/T1D_analysis/01_ImportData_cells_Uncompressed.Rmd')"

## Key variables

Details for some of the key variables in the `SpatialExperiment` object 
generated by this script.  

**Column data**  
The data frame can be accessed with `colData(spe)`.  
- `image_id`: unique image id (corresponds to one IMC ablated region).  
- `sample_id`: same as `image_id`, duplicated for convenience as the 
`sample_id` column is hard-coded in the `SpatialExperiment` format, which can
cause issues when splitting and re-merging.  
- `cell_number`: corresponds to the label of the cell in the cell mask.    
- `cell_id`: unique cell id (sample id + cell number).  
- `case_id`: patient id.  
- `donor_type`: patient type 1 diabetes stage.  

**Row data**  
The data frame can be accessed with `rowData(spe)`.  
- `name`: name of the antibody target.  
- `short_name`: abbreviated name of the antibody target.  

# **Settings**

## Load packages

```{r packages, results='hide'}
suppressPackageStartupMessages(c(
  library(imcRtools),
  library(vroom),
  library(dplyr),
  library(BiocParallel)
))
```


## Paths

IMPORTANT:
**Before running this script, make sure to set the correct paths in the helpers.R file.**

Adjust the following variables: 
- `home`: path to the folder containing the pre-processed data.

Edit folder and file names if needed

```{r paths}
panels <- c("Uncompressed")

# Name of the T1D processing output directories
dir_data_cells <- file.path("data_cells", paths$panel_type)

# Check existence.
if (!dir.exists(file.path(paths$folder_in, dir_data_cells, "intensities"))) stop(paste("Cell data not found."))

# Antibody panel
fn_panel <- file.path(paths$folder_in, paste0("panel_", paths$panel_type, ".csv"))
# Image metadata
fn_image_metadata <- file.path(paths$folder_in, paste0("images_", paths$panel_type, ".csv"))
# Clinical metadata
fn_cases <- file.path(paths$folder_in, "cases.csv")

if (!file.exists(fn_panel)) stop("Panel file not found")
if (!file.exists(fn_image_metadata)) stop("Image metadata file not found")
if (!file.exists(fn_cases)) stop("Clinical data file not found")
```



# **Import data**

## Load metadata files

```{r read-metadata}
panel <- vroom(fn_panel, show_col_types = FALSE)
image_metadata <- vroom(fn_image_metadata, show_col_types = FALSE)
cases <- vroom(fn_cases, show_col_types = FALSE)
```


## Read in cell data

The [imcRtools](https://bioconductor.org/packages/release/bioc/html/imcRtools.html)
package is used to read in cell data generated by the `T1D preprocessing` 
pipeline. The cell data is automatically formatted as a [SpatialExperiment (SPE) object](https://bioconductor.org/packages/release/bioc/html/SpatialExperiment.html).
Note: this takes considerable time; around 15 min.

```{r read-data}
start_time <- Sys.time()

spe <- imcRtools::read_steinbock(
  path = paths$folder_in,
  intensities_folder = file.path(dir_data_cells, "intensities"),
  regionprops_folder = file.path(dir_data_cells, "regionprops"),
  graphs_folder = NULL, # file.path(dir_data_cells, "neighbors"),
  extract_cellid_from = "Object",
  extract_coords_from = c("centroid-1", "centroid-0"),
  image_file = basename(fn_image_metadata),
  extract_imagemetadata_from = colnames(image_metadata),
  panel_file = fn_panel,
  extract_names_from = "name",
  return_as = c("spe"),
  BPPARAM = MulticoreParam()
)

end_time <- Sys.time()
cat("Processing time for loading the data:", (end_time - start_time), "\n")

# Print the generated SPE object
print(spe)
```


### Add sample information


```{r fix-splits}
# Add full image names
spe$image_fullname <- paste0(spe$sample_id, ".tiff")

# Remove "ROI" from sample ids (not useful)
spe$sample_id <- gsub("ROI_", "", spe$sample_id)
```

```{r sample-info}
# Extract sample information from sample_id column
colData(spe) <- tidyr::separate(
  as.data.frame(colData(spe)),
  col = sample_id, sep = "_",
  into = c("case_id", "panel", "image_number")) |>
  DataFrame()

# Convert image numbers to integers
spe$image_number <- as.integer(spe$image_number)

# Add unique cell identifiers (cell_id)
spe$cell_id <- paste(spe$sample_id, spe$ObjectNumber, sep = "_")

# Add image_id column (sample_id is hardcoded in SpatialExperiment)
spe$image_id <- spe$sample_id
```

### Update column names

Use standardized column names and remove unneeded columns

```{r fix-column-names}
# Columns to delete in colData
drop_cols <- c(
  "num_channels", "acquisition_description", "source_file", "recovery_file",
  "recovered", "acquisition_id", "acquisition_width_um",
  "acquisition_height_um", "acquisition_end_x_um", "acquisition_end_y_um"
)

# Rename and delete columns
colData(spe) <- colData(spe) |>
  tibble::as_tibble() |>
  dplyr::rename(
    cell_number = ObjectNumber,
    cell_area = area,
    cell_major_axis_length = major_axis_length,
    cell_minor_axis_length = minor_axis_length,
    cell_eccentricity = eccentricity,
    image_x = acquisition_start_x_um,
    image_y = acquisition_start_y_um
  ) |>
  dplyr::select(-any_of(drop_cols)) |> 
  DataFrame()

# Rename SpatialCoords slot columns
spatialCoordsNames(spe) <- c("cell_x", "cell_y")
```


### Add clinical data

Import clinical information about organ donors.
Clean column types of the clinical data before merging.

```{r add-case-info}
# Convert cat. variables to factors
cases <- cases |> 
  dplyr::mutate(across(c(case_number, race, gender, donor_type, 
                         number_of_AAbs, GADA, IA2A, mIAA, ZnT8A), 
                       ~ factor(.x, exclude = NULL))) |> 
  dplyr::mutate(case_id = as.character(case_id),
                C_peptide = as.numeric(C_peptide))

colData(spe) <- colData(spe)  |> 
  tibble::as_tibble() |> 
  dplyr::left_join(cases, by = "case_id") |> 
  DataFrame()
```


## Update SPE object rownames and colnames

Add unique cell ids as colnames and short protein names as rownames.

```{r add-colnames}
colnames(spe) <- spe$cell_id
print(colData(spe))
```

```{r add-rownames}
rownames(spe) <- rowData(spe)$shortname
print(rowData(spe))
```

## Tasks:

Inspect the generate SPE object. 
Make yourself familiar with the structure of the SPE object.
 
```{r inspect-spe}
print(spe)
```

Q1: How many cells are in the dataset?
Q2: How many ROIs did we acquire?
Q3: What is the age of the organ donors?


# **Save cell data**

Save the generated SPE object for downstream analyses.

```{r save-spe}
fn_spe <- file.path(paths$folder_out, paste0(paths$object_type, "_", paths$panel_type, ".rds"))
saveRDS(spe, fn_spe)
```
